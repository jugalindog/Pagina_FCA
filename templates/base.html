<!DOCTYPE html>
<html lang="en">
  <head>
    {% block head %}
    <title>Datos y Estadísticas - FCA UNAL</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Favicon y estilos -->
    <link
      rel="shortcut icon"
      type="image/x-icon"
      href="{{ url_for('static', filename= 'images/logoFCA.ico') }}"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Arvo&display=swap"
      rel="stylesheet"
    />

    <link
      rel="stylesheet"
      href="{{ url_for('static', filename= 'beauty.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
      integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
      crossorigin="anonymous"
    />
    
    <!-- Scripts necesarios -->
    <script
      src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
      integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
      integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
      integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
      crossorigin="anonymous"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    {% endblock %}
  </head>

  <body>
    <!-- Barra de navegación -->
    <nav class="navbar navbar-dark" style="background-color: #555555;">
      <a class="navbar-brand" href="{{ url_for('main.UI') }}">
        Datos y Estadísticas - FCA UNAL
        {% if page_title %}
          <span class="text-white">| {{ page_title }}</span>
        {% endif %}
        {% if sub_page_title %}
          <span class="text-white">| {{ sub_page_title }}</span>
        {% endif %}
        {% if session.user_email %}
          <small class="text-white-50 ml-2">| {{ session.user_email }}</small>
        {% endif %}
      </a>
      
      <!-- Contenedor para alinear a la derecha -->
      <div class="d-flex align-items-center">
        <!-- Elemento para mostrar el contador de sesión -->
        <span id="session-timer" class="navbar-text text-white mr-3"></span>
        <!-- Botón de hamburguesa -->
        <button
          class="navbar-toggler"
          type="button"
          data-toggle="collapse"
          data-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>

      <div class="collapse navbar-collapse" id="navbarSupportedContent">
         <ul class="navbar-nav d-flex flex-row justify-content-between w-100" style="gap: 1rem;padding: 0 5rem;">
          <li class="nav-item">
            <a href="{{ url_for('main.secretaria') }}" class="btn btn-hover-green text-white" id = "btn-hover-green" >Datos Secretaría</a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('main.ViceDecanatura') }}" class="btn btn-hover-green text-white" id = "btn-hover-green" >Datos ViceDecanatura</a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('main.Bienestar') }}" class="btn btn-hover-green text-white" id = "btn-hover-green">Datos Bienestar</a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('main.curricular') }}" class="btn btn-hover-green text-white" id = "btn-hover-green">Datos Curricular</a>
          </li>
          <li class="nav-item">
            <a href="{{ url_for('main.normatividad') }}" class="btn btn-hover-green text-white" id = "btn-hover-green">Normatividad</a>
          </li>
          <li class="nav-item">
            <button id="info-button" type="button" class="btn btn-outline-info text-white">Información</button>
          </li>
          <li class="nav-item">
           <a href="{{ url_for('main.logout') }}" class="btn btn-outline-danger"> Cerrar sesión</a>
          </li>
        </ul>
      </div>
    </nav>
    
    <!-- Contenido principal -->
    {% block content %} {% endblock %}

    <!-- Scripts de la aplicación -->
    <script>
    // Configuración del temporizador de sesión
    const MINUTES = 15;
    const WARNING_BEFORE = 1; // Minutos antes de expirar para mostrar advertencia
    const SESSION_TIMEOUT = MINUTES * 60 * 1000;
    const WARNING_TIMEOUT = (MINUTES - WARNING_BEFORE) * 60 * 1000;

    let timer;
    let warningTimer;
    let displayInterval;
    let sessionEndTime;

    // Función para reiniciar el temporizador de sesión
    function resetTimer() {
        clearTimeout(timer);
        clearTimeout(warningTimer);
        clearInterval(displayInterval);

        sessionEndTime = Date.now() + SESSION_TIMEOUT;

        function updateDisplay() {
            const remaining = sessionEndTime - Date.now();
            if (remaining <= 0) {
                document.getElementById('session-timer').textContent = 'Expirando...';
                clearInterval(displayInterval);
                return;
            }
            const minutes = Math.floor((remaining / 1000) / 60);
            const seconds = Math.floor((remaining / 1000) % 60);
            document.getElementById('session-timer').textContent = `Sesión expira en: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        updateDisplay();
        displayInterval = setInterval(updateDisplay, 1000);

        // Configurar advertencia
        warningTimer = setTimeout(() => {
            Swal.fire({
                title: '¡Advertencia!',
                text: `Tu sesión expirará en ${WARNING_BEFORE} minuto(s)`,
                icon: 'warning',
                confirmButtonText: 'Mantener sesión',
                showCancelButton: true,
                cancelButtonText: 'Cerrar sesión',
                allowOutsideClick: false
            }).then((result) => {
                if (result.isConfirmed) {
                    // Hacemos una llamada al servidor para que también reinicie su temporizador.
                    fetch("{{ url_for('main.keep_alive') }}")
                        .then(response => response.json())
                        .then(data => {
                            resetTimer(); // Reiniciar el temporizador del cliente
                        });
                } else {
                    window.location.href = "{{ url_for('main.logout') }}";
                }
            });
        }, WARNING_TIMEOUT);

        // Configurar expiración
        timer = setTimeout(() => {
            Swal.fire({
                title: '¡Sesión Expirada!',
                text: 'Tu sesión ha expirado por inactividad',
                icon: 'warning',
                confirmButtonText: 'Entendido',
                allowOutsideClick: false
            }).then((result) => {
                window.location.href = "{{ url_for('main.logout') }}";
            });
        }, SESSION_TIMEOUT);
    }

    // Eventos que reinician el temporizador
    ['mousemove', 'keypress', 'click', 'scroll'].forEach(event => {
        document.addEventListener(event, resetTimer);
    });

    const infoButton = document.getElementById('info-button');
    if (infoButton) {
        infoButton.addEventListener('click', () => {
            Swal.fire({
                title: 'Información',
                html: 'Si requiere de ayuda con alguna petición o corrección, por favor haga click y comuníquese al correo  <br> <a href="https://mail.google.com/mail/?view=cm&fs=1&to=estadisticas_fcabog@unal.edu.co" target="_blank" rel="noopener noreferrer">estadisticas_fcabog@unal.edu.co</a>.',
                icon: 'info',
                confirmButtonText: 'Entendido'
            });
        });
    }

    // Iniciar el temporizador
    resetTimer();

    // Recargar página al volver atrás para evitar problemas de caché
    if (performance.navigation.type === 2) {
        location.reload(true);
    }
</script>
  </body>
</html>
